<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.4 at 2016-05-12 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Perf4J 2.0-SNAPSHOT - Developer Guide</title>
    <style type="text/css" media="all">
      @import url("css/maven-base.css");
      @import url("css/maven-theme.css");
      @import url("css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20160512" />
    <meta http-equiv="Content-Language" content="en" />
                                                    
<script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
                var gaS = "%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"; document.write(unescape(gaS));</script>
                                                        
<script type="text/javascript">var pageTracker = _gat._getTracker("UA-5369441-1");
                pageTracker._initData();
                pageTracker._trackPageview();</script>
                                                        
<meta content="sRQSq4VA5FRMhwzFB4U3I9AtgLMtIWTdpVVO6jg1az4=" name="verify-v1"/>
                      
        </head>
  <body class="composite">
    <div id="banner">
                        <a href="http://www.homeaway.com" id="bannerLeft">
                                                <img src="images/homeaway_logo.png" alt="$alt" />
                </a>
                                            <a href="index.html" id="bannerRight">
                Perf4J 2.0-SNAPSHOT
                </a>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="projectVersion">Version: 2.0-SNAPSHOT</span>
              </div>
            <div class="xright">                    <a href="index.html" title="Home">Home</a>
            |
                        <a href="releases.html" title="Release Notes">Release Notes</a>
              
                    
                &nbsp;| <span id="publishDate">Last Published: 2016-05-12</span>
            </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Main</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="releases.html" title="Release Notes">Release Notes</a>
            </li>
                  <li class="none">
                          <a href="downloads.html" title="Downloads">Downloads</a>
            </li>
          </ul>
                       <h5>Documentation</h5>
                  <ul>
                  <li class="none">
            <strong>Developer Guide</strong>
          </li>
                  <li class="none">
                          <a href="apidocs/index.html" title="Javadoc">Javadoc</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                                            <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                                                                              <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                                                                                                                               <a href="http://maven.apache.org/" title="Maven" class="poweredBy">
        <img class="poweredBy"  alt="Maven" src="http://maven.apache.org/images/logos/maven-feather.png"     />
      </a>
                                                                                                                      <a href="http://www.homeaway.com" title="Homeaway" class="poweredBy">
        <img class="poweredBy"  alt="Homeaway" src="images/homeaway_logo.png"     />
      </a>
                       
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section">
<h2>Perf4J Developer Guide<a name="Perf4J_Developer_Guide"></a></h2>
<p>This guide describes how to incorporate Perf4J timing statements into your code, and how to use and enable various Perf4J tools to analyze and visualize the generated performance data. To run the examples you'll need to <a href="./downloads.html">download</a> the Perf4J jar file and place it in your classpath. Some of the the Perf4J tools require additional dependencies (for example, the custom log4j appenders require the log4j jar to also be in your classpath). The examples shown will specify these additional dependencies when necessary.</p>
<ul>
<li><a href="#Perf4J_Developer_Guide">Perf4J Developer Guide</a>
<ul>
<li><a href="#Adding_Timing_Statements">Adding Timing Statements</a></li>
<li><a href="#Parsing_Log_Files_to_Generate_Performance_Statistics">Parsing Log Files to Generate Performance Statistics</a></li>
<li><a href="#Using_the_log4j_Appenders_to_Generate_Real-Time_Performance_Information">Using the log4j Appenders to Generate Real-Time Performance Information</a>
<ul>
<li><a href="#Writing_Graphs_with_the_GraphingStatisticsAppender">Writing Graphs with the GraphingStatisticsAppender</a></li>
<li><a href="#Exposing_Performance_Statistics_as_JMX_Attributes">Exposing Performance Statistics as JMX Attributes</a></li></ul></li>
<li><a href="#Exposing_Performance_Graphs_in_a_Web_Application">Exposing Performance Graphs in a Web Application</a></li>
<li><a href="#Unobtrusive_Logging_with_Profiled_and_AOP">Unobtrusive Logging with @Profiled and AOP</a>
<ul>
<li><a href="#Adding_the_Profiled_Annotation_to_Method_Declarations">Adding the Profiled Annotation to Method Declarations</a></li>
<li><a href="#Using_AspectJ_Load-Time_Weaving_to_Integrate_Timing_Aspects_at_Run_Time">Using AspectJ Load-Time Weaving to Integrate Timing Aspects at Run Time</a></li>
<li><a href="#Using_the_AspectJ_Compiler_to_Integrate_Timing_Aspects_at_Compile_Time">Using the AspectJ Compiler to Integrate Timing Aspects at Compile Time</a></li>
<li><a href="#Using_Spring_AOP_to_Integrate_Timing_Aspects">Using Spring AOP to Integrate Timing Aspects</a></li>
<li><a href="#Using_EJB_Interceptors_to_Integrate_Timing_Aspects">Using EJB Interceptors to Integrate Timing Aspects</a></li></ul></li></ul></li></ul>
<div class="section">
<h3><a name="Adding_Timing_Statements">Adding Timing Statements</a></h3>
<p>The <a href="./apidocs/org/perf4j/LoggingStopWatch.html">org.perf4j.LoggingStopWatch</a> class or one of its logging-framework specific subclasses is used to calculate execution times and log them as shown:</p>
<div class="source">
<pre>// Create the LoggingStopWatch to start timing. This constructor takes the tag
// name, which identifies the code block being timed. Note that usually you
// will want to instantiate one of the subclasses of LoggingStopWatch, such as
// a Log4JStopWatch or CommonsLogStopWatch depending on your preferred
// logging framework.
StopWatch stopWatch = new LoggingStopWatch(&quot;codeBlock1&quot;);

// Execute the code block - this is just a dummy call to pause execution for
// 0-1 second.
Thread.sleep((long)(Math.random() * 1000L));

// Stop the StopWatch and log it. LoggingStopWatches automatically log their
// timing statements when one of the stop() or lap() methods are called.
stopWatch.stop();</pre></div>
<p>The above block results in the following output to the standard error stream when the block is executed multiple times. Note that if you were using one of the LoggingStopWatch subclasses it would output to the log file configured in your logging framework:</p>
<div class="source">
<pre>INFO: start[1230448905165] time[704] tag[codeBlock1]
INFO: start[1230448905898] time[564] tag[codeBlock1]
INFO: start[1230448906462] time[367] tag[codeBlock1]
INFO: start[1230448906830] time[153] tag[codeBlock1]
INFO: start[1230448906983] time[830] tag[codeBlock1]
INFO: start[1230448907813] time[834] tag[codeBlock1]
INFO: start[1230448908648] time[229] tag[codeBlock1]
INFO: start[1230448908877] time[93] tag[codeBlock1]
INFO: start[1230448908970] time[748] tag[codeBlock1]
INFO: start[1230448909720] time[559] tag[codeBlock1]</pre></div>
<p>In addition to the stop watch tag, you can also specify an optional message. The tag and message can be specified either in the StopWatch constructor or in the call to stop(), which allows you to change the tag depending on the code being timed like so:</p>
<div class="source">
<pre>StopWatch stopWatch = new LoggingStopWatch();

try {
    // the code block being timed - this is just a dummy example
    long sleepTime = (long)(Math.random() * 1000L);
    Thread.sleep(sleepTime);
    if (sleepTime &gt; 500L) {
        throw new Exception(&quot;Throwing exception&quot;);
    }

    stopWatch.stop(&quot;codeBlock2.success&quot;, &quot;Sleep time was &lt; 500 ms&quot;);
} catch (Exception e) {
    stopWatch.stop(&quot;codeBlock2.failure&quot;, &quot;Exception was: &quot; + e);
}</pre></div>
<p>The above code creates the sample following output when run in a loop:</p>
<div class="source">
<pre>INFO: start[1230493236109] time[447] tag[codeBlock2.success] message[Sleep time was &lt; 500 ms]
INFO: start[1230493236719] time[567] tag[codeBlock2.failure] message[Exception was: java.lang.Exception: Throwing exception]
INFO: start[1230493237286] time[986] tag[codeBlock2.failure] message[Exception was: java.lang.Exception: Throwing exception]
INFO: start[1230493238273] time[194] tag[codeBlock2.success] message[Sleep time was &lt; 500 ms]
INFO: start[1230493238467] time[463] tag[codeBlock2.success] message[Sleep time was &lt; 500 ms]
INFO: start[1230493238930] time[310] tag[codeBlock2.success] message[Sleep time was &lt; 500 ms]
INFO: start[1230493239241] time[610] tag[codeBlock2.failure] message[Exception was: java.lang.Exception: Throwing exception]
INFO: start[1230493239852] time[84] tag[codeBlock2.success] message[Sleep time was &lt; 500 ms]
INFO: start[1230493239937] time[30] tag[codeBlock2.success] message[Sleep time was &lt; 500 ms]
INFO: start[1230493239968] time[852] tag[codeBlock2.failure] message[Exception was: java.lang.Exception: Throwing exception]</pre></div>
<p>Note that in addition to explicitly creating StopWatches in code, you can also use the <a href="./apidocs/org/perf4j/aop/Profiled.html">org.perf4j.aop.Profiled</a> annotation to mark methods that should be timed. The use of the @Profiled annotation together with an aspect-oriented programming framework like AspectJ or Spring AOP is <a href="#Unobtrusive_Logging_with_Profiled_and_AOP">described below</a>.</p></div>
<div class="section">
<h3><a name="Parsing_Log_Files_to_Generate_Performance_Statistics">Parsing Log Files to Generate Performance Statistics</a></h3>
<p>Once you have set up the logging in your application to log execution times, you will want to parse those log files to generate aggregated performance statistics such as mean, min and max times. Here is an example using the log parser. Note that <a href="./apidocs/org/perf4j/LogParser.html">org.perf4j.LogParser</a> is configured as the main class to run in the perf4j jar file, so the parser can be run as follows:</p>
<div class="source">
<pre>java -jar perf4j-0.9.16.jar times.log</pre></div>
<p>Sample output from the log parser looks like this:</p>
<div class="source">
<pre>Performance Statistics   20:32:00 - 20:32:30
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
codeBlock1                                             249.4           2         487       151.3          37
codeBlock2.failure                                     782.9         612         975       130.8          17
codeBlock2.success                                     260.7           6         500       159.5          20

Performance Statistics   20:32:30 - 20:33:00
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
codeBlock1                                             244.0           7         494       150.6          41
codeBlock2.failure                                     747.9         531         943       125.3          21
codeBlock2.success                                     224.1          26         398       106.8          21

Performance Statistics   20:33:00 - 20:33:30
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
codeBlock1                                             289.3          10         464       141.1          22
codeBlock2.failure                                     781.1         599         947       135.1           8
codeBlock2.success                                     316.2         115         490       112.6          13</pre></div>
<p>The log parser also supports output in comma-separated values format:</p>
<div class="source">
<pre>java -jar perf4j-0.9.16.jar -f csv times.log

&quot;codeBlock1&quot;,2009-02-01 16:24:00,2009-02-01 16:24:30,488.15624999999994,31,962,293.98800032643766,32
&quot;codeBlock2.failure&quot;,2009-02-01 16:24:00,2009-02-01 16:24:30,772.6666666666667,535,962,119.15125774502854,15
&quot;codeBlock2.success&quot;,2009-02-01 16:24:00,2009-02-01 16:24:30,237.11764705882356,31,461,125.37749228204501,17
&quot;codeBlock1&quot;,2009-02-01 16:24:30,2009-02-01 16:25:00,412.69117647058846,0,979,289.32097265193715,68
&quot;codeBlock2.failure&quot;,2009-02-01 16:24:30,2009-02-01 16:25:00,727.5,501,979,142.69959031799314,26
&quot;codeBlock2.success&quot;,2009-02-01 16:24:30,2009-02-01 16:25:00,217.8095238095238,0,492,153.59009115100247,42</pre></div>
<p>Note that if no log file is specified the Perf4J log parser by default reads from standard input. Thus, one way to get real-time performance statistics from a live application is to use the Unix <tt>tail</tt> command to pipe the raw log file to the log parser. The following example assumes a live application is writing StopWatch log messages to a times.log file. The performance statistics will be written to the console as new data is written to times.log:</p>
<div class="source">
<pre>tail -f times.log | java -jar perf4j-0.9.16.jar</pre></div>
<p>In addition to generating performance statistics, the Perf4J log parser can also generate graphs. Here is an example:</p>
<div class="source">
<pre>java -jar perf4j-0.9.16.jar --graph perfGraphs.out times.log</pre></div>
<p>This command writes performance graphs to the perfGraphs.out file using the Google Chart API. Here are some example <a class="externalLink" href="http://chart.apis.google.com/chart?cht=lxy&amp;chtt=Mean&amp;chs=750x400&amp;chxt=x,x,y&amp;chd=t:0.0,50.0,100.0|31.1,40.3,24.1|0.0,50.0,100.0|40.9,27.9,33.0|0.0,50.0,100.0|99.1,100.0,90.9&amp;chco=ff0000,00ff00,0000ff&amp;chm=d,ff0000,0,-1,5.0|d,00ff00,1,-1,5.0|d,0000ff,2,-1,5.0&amp;chdl=codeBlock2.success|codeBlock1|codeBlock2.failure&amp;chxr=2,0,767.4&amp;chxl=0:|20:38:00|20:38:30|20:39:00|1:|Time&amp;chxp=0,0.0,50.0,100.0|1,50&amp;chg=50.0,10">Mean Time</a> and <a class="externalLink" href="http://chart.apis.google.com/chart?cht=lxy&amp;chtt=TPS&amp;chs=750x400&amp;chxt=x,x,y&amp;chd=t:0.0,50.0,100.0|42.5,50.0,32.5|0.0,50.0,100.0|77.5,100.0,72.5|0.0,50.0,100.0|35.0,50.0,40.0&amp;chco=ff0000,00ff00,0000ff&amp;chm=d,ff0000,0,-1,5.0|d,00ff00,1,-1,5.0|d,0000ff,2,-1,5.0&amp;chdl=codeBlock2.success|codeBlock1|codeBlock2.failure&amp;chxr=2,0,1.3&amp;chxl=0:|20:38:00|20:38:30|20:39:00|1:|Time&amp;chxp=0,0.0,50.0,100.0|1,50&amp;chg=50.0,10">Transactions Per Second</a> graphs.</p>
<p>The Perf4J log parser contains a number of other options; use the <tt>--help</tt> flag to get more usage information.</p></div>
<div class="section">
<h3><a name="Using_the_log4j_Appenders_to_Generate_Real-Time_Performance_Information">Using the log4j Appenders to Generate Real-Time Performance Information</a></h3>
<p>One of the main benefits of Perf4J is that it allows performance analysis and monitoring on live production applications through extensions to common logging frameworks like log4j and logback. These custom log4j appenders can be configured through the standard configuration mechanisms to add functionality without requiring changes to code. Note that all of the examples given below assume that you have the <a class="externalLink" href="http://repo1.maven.org/maven2/log4j/log4j/1.2.14/log4j-1.2.14.jar">log4j jar</a>, version 1.2.14 or higher, in your classpath.</p>
<p><b>Important note for logback users:</b> Support for the <a class="externalLink" href="http://logback.qos.ch/">logback</a> logging framework was added in Perf4J 0.9.16. All of the log4j appenders mentioned in the examples below have corresponding logback versions. See the <a href="./apidocs/index.html?org/perf4j/logback/package-summary.html">javadoc</a> for more information.</p>
<p>The most important Perf4J appender is the <a href="./apidocs/org/perf4j/log4j/AsyncCoalescingStatisticsAppender.html">AsyncCoalescingStatisticsAppender</a>. This appender takes all of the logged StopWatch messages within a specified timespan, aggregates them to a single <tt>GroupedTimingStatistics</tt> log message, and then sends this single message to any downstream appenders (such as FileAppenders or one of the other custom Perf4J appenders, described below).</p>
<p>Here is a sample log4j.xml file that is used to configure an AsyncCoalescingStatisticsAppender to log statistics data to a file. <b>IMPORTANT</b> Due to the fact that you must attach downstream appenders to an AsyncCoalescingStatisticsAppender for it to be useful, you cannot configure an AsyncCoalescingStatisticsAppender instance in a log4j.properties file, but instead must use the log4j XML config file format (this is also required when using a standard org.apache.log4j.AsyncAppender, for example).</p>
<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE log4j:configuration SYSTEM &quot;log4j.dtd&quot;&gt;

&lt;log4j:configuration debug=&quot;false&quot; xmlns:log4j=&quot;http://jakarta.apache.org/log4j/&quot;&gt;
    &lt;!--
      This default ConsoleAppender is used to log all NON perf4j messages
      to System.out
    --&gt;
    &lt;appender name=&quot;console&quot; class=&quot;org.apache.log4j.ConsoleAppender&quot;&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot; value=&quot;%-5p %c{1} - %m%n&quot;/&gt;
        &lt;/layout&gt;
    &lt;/appender&gt; 

    &lt;!-- Perf4J appenders --&gt;
    &lt;!--
       This AsyncCoalescingStatisticsAppender groups StopWatch log messages
       into GroupedTimingStatistics messages which it sends on the
       file appender defined below
    --&gt;
    &lt;appender name=&quot;CoalescingStatistics&quot;
              class=&quot;org.perf4j.log4j.AsyncCoalescingStatisticsAppender&quot;&gt;
        &lt;!--
          The TimeSlice option is used to determine the time window for which
          all received StopWatch logs are aggregated to create a single
          GroupedTimingStatistics log. Here we set it to 10 seconds, overriding
          the default of 30000 ms
        --&gt;
        &lt;param name=&quot;TimeSlice&quot; value=&quot;10000&quot;/&gt;
        &lt;appender-ref ref=&quot;fileAppender&quot;/&gt;
    &lt;/appender&gt;

    &lt;!-- This file appender is used to output aggregated performance statistics --&gt;
    &lt;appender name=&quot;fileAppender&quot; class=&quot;org.apache.log4j.FileAppender&quot;&gt;
        &lt;param name=&quot;File&quot; value=&quot;perfStats.log&quot;/&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot; value=&quot;%m%n&quot;/&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

    &lt;!-- Loggers --&gt;
    &lt;!--
      The Perf4J logger. Note that org.perf4j.TimingLogger is the value of the
      org.perf4j.StopWatch.DEFAULT_LOGGER_NAME constant. Also, note that
      additivity is set to false, which is usually what is desired - this means
      that timing statements will only be sent to this logger and NOT to
      upstream loggers.
    --&gt;
    &lt;logger name=&quot;org.perf4j.TimingLogger&quot; additivity=&quot;false&quot;&gt;
        &lt;level value=&quot;INFO&quot;/&gt;
        &lt;appender-ref ref=&quot;CoalescingStatistics&quot;/&gt;
    &lt;/logger&gt;

    &lt;!--
      The root logger sends all log statements EXCEPT those sent to the perf4j
      logger to System.out.
    --&gt;
    &lt;root&gt;
        &lt;level value=&quot;INFO&quot;/&gt;
        &lt;appender-ref ref=&quot;console&quot;/&gt;
    &lt;/root&gt;
&lt;/log4j:configuration&gt;</pre></div>
<p>The following simple example class makes use of the above configuration file to write the performance logs:</p>
<div class="source">
<pre>import org.apache.log4j.*;
import org.perf4j.*;

public class Perf4JAppenderExample {
    public static void main (String[] args) throws Exception {
        // note that the log4j framework will automatically load the log4j.xml
        // file if it is in a root directory on the classpath

        Logger rootLogger = Logger.getRootLogger();

        for (int i = 0; i &lt; 50; i++) {
            // By default the Log4JStopWatch uses the Logger named org.perf4j.TimingLogger
            StopWatch stopWatch = new Log4JStopWatch();

            // for demo purposes just sleep
            Thread.sleep((long) (Math.random() * 1000L));

            rootLogger.info(&quot;Normal logging messages only go to the console&quot;);

            // Calling lap() stops timing for the previous block, sends the
            // message to the log4j Logger, and starts timing the next block.
            stopWatch.lap(&quot;firstBlock&quot;);

            Thread.sleep((long) (Math.random() * 2000L));

            stopWatch.stop(&quot;secondBlock&quot;);
        }

    }
}</pre></div>
<p>Note that only the messages logged with the rootLogger (&quot;Normal logging messages only go to the console&quot;) are displayed on the console - this is because the additivity flag is set to false on the org.perf4j.TimingLogger in the log4j.xml config. Here is some sample output written to perfStats.log:</p>
<div class="source">
<pre>Performance Statistics   17:05:40 - 17:05:50
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
firstBlock                                             434.2         128         869       309.7           6
secondBlock                                            968.4         196        1996       675.5           5

Performance Statistics   17:05:50 - 17:06:00
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
firstBlock                                             523.0         178         793       225.8           6
secondBlock                                           1126.3         332        1560       377.6           7

Performance Statistics   17:06:00 - 17:06:10
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
firstBlock                                             806.0         583         930       114.8           6
secondBlock                                            713.8         308        1045       282.1           6

Performance Statistics   17:06:10 - 17:06:20
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
firstBlock                                             516.8         164         950       239.0           8
secondBlock                                            771.3         149        1853       491.0           8

Performance Statistics   17:06:20 - 17:06:30
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
firstBlock                                             447.3         108         852       223.2           7
secondBlock                                           1102.2         406        1906       503.1           6

Performance Statistics   17:06:30 - 17:06:40
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
firstBlock                                             511.3          30         892       254.7           6
secondBlock                                           1043.9         237        1350       368.2           7

Performance Statistics   17:06:40 - 17:06:50
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
firstBlock                                             290.7         152         511       114.5           7
secondBlock                                           1128.0         598        1891       421.1           7

Performance Statistics   17:06:50 - 17:07:00
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
firstBlock                                             530.5         138         902       278.7           4
secondBlock                                           1140.3         516        1649       447.5           4</pre></div>
<p>Similar to the log parser, the log4j appender supports CSV-formatted output by way of the <a href="./apidocs/org/perf4j/log4j/StatisticsCsvLayout.html">StatisticsCsvLayout</a>. That is, by replacing the PatternLayout with a StatisticsCsvLayout on the fileAppender, output will be CSV formatted instead of text formatted as shown above. The StatisticsCsvLayout supports a number of options to customize which data values are output; see the javadoc for more information.</p>
<div class="section">
<h4><a name="Writing_Graphs_with_the_GraphingStatisticsAppender">Writing Graphs with the GraphingStatisticsAppender</a></h4>
<p>One of the main benefits of using the AsyncCoalescingStatisticsAppender is that other custom Perf4J appenders that handle GroupedTimingStatistics messages can be attached to an AsyncCoalescingStatisticsAppender in order to display or analyze the statistics in other useful ways. The <a href="./apidocs/org/perf4j/log4j/GraphingStatisticsAppender.html">GraphingStatisticsAppender</a> uses the GroupedTimingStatistics to generate performance graphs. These graphs, which are implemented as URLs using the <a class="externalLink" href="http://code.google.com/apis/chart/">Google Chart API</a> to create the actual graph images, can then be displayed in a browser, or <a href="#Exposing_Performance_Graphs_in_a_Web_Application">exposed in a running web server</a>.</p>
<p>The log4j.xml shown below extends the log4j.xml previously shown with the new GraphingStatisticsAppenders:</p>
<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE log4j:configuration SYSTEM &quot;log4j.dtd&quot;&gt;

&lt;log4j:configuration debug=&quot;false&quot; xmlns:log4j=&quot;http://jakarta.apache.org/log4j/&quot;&gt;
    &lt;!--
      This default ConsoleAppender is used to log all NON perf4j messages
      to System.out
    --&gt;
    &lt;appender name=&quot;console&quot; class=&quot;org.apache.log4j.ConsoleAppender&quot;&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot; value=&quot;%-5p %c{1} - %m%n&quot;/&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

    &lt;!-- Perf4J appenders --&gt;
    &lt;!--
      This AsyncCoalescingStatisticsAppender groups StopWatch log messages
      into GroupedTimingStatistics messages which it sends on the
      file appender defined below
    --&gt;
    &lt;appender name=&quot;CoalescingStatistics&quot;
              class=&quot;org.perf4j.log4j.AsyncCoalescingStatisticsAppender&quot;&gt;
        &lt;!--
          The TimeSlice option is used to determine the time window for which
          all received StopWatch logs are aggregated to create a single
          GroupedTimingStatistics log. Here we set it to 10 seconds, overriding
          the default of 30000 ms
        --&gt;
        &lt;param name=&quot;TimeSlice&quot; value=&quot;10000&quot;/&gt;
        &lt;appender-ref ref=&quot;fileAppender&quot;/&gt;
        &lt;!--
          Note how the GraphingStatisticsAppenders have been attached to the
          CoalescingStatistics here.
        --&gt;
        &lt;appender-ref ref=&quot;graphExecutionTimes&quot;/&gt;
        &lt;appender-ref ref=&quot;graphExecutionTPS&quot;/&gt;
    &lt;/appender&gt;

    &lt;!-- This file appender is used to output aggregated performance statistics --&gt;
    &lt;appender name=&quot;fileAppender&quot; class=&quot;org.apache.log4j.FileAppender&quot;&gt;
        &lt;param name=&quot;File&quot; value=&quot;perfStats.log&quot;/&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot; value=&quot;%m%n&quot;/&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

    &lt;!--
      This first GraphingStatisticsAppender graphs Mean execution times for the
      firstBlock and secondBlock tags
    --&gt;
    &lt;appender name=&quot;graphExecutionTimes&quot;
              class=&quot;org.perf4j.log4j.GraphingStatisticsAppender&quot;&gt;
        &lt;!-- Possible GraphTypes are Mean, Min, Max, StdDev, Count and TPS --&gt;
        &lt;param name=&quot;GraphType&quot; value=&quot;Mean&quot;/&gt;
        &lt;!-- The tags of the timed execution blocks to graph are specified here --&gt;
        &lt;param name=&quot;TagNamesToGraph&quot; value=&quot;firstBlock,secondBlock&quot;/&gt;
        &lt;appender-ref ref=&quot;graphsFileAppender&quot;/&gt;
    &lt;/appender&gt;

    &lt;!--
      This second GraphingStatisticsAppender graphs transactions per second
      for the firstBlock and secondBlock tags
    --&gt;
    &lt;appender name=&quot;graphExecutionTPS&quot;
              class=&quot;org.perf4j.log4j.GraphingStatisticsAppender&quot;&gt;
        &lt;param name=&quot;GraphType&quot; value=&quot;TPS&quot;/&gt;
        &lt;param name=&quot;TagNamesToGraph&quot; value=&quot;firstBlock,secondBlock&quot;/&gt;
        &lt;appender-ref ref=&quot;graphsFileAppender&quot;/&gt;
    &lt;/appender&gt;

    &lt;!--
      This file appender is used to output the graph URLs generated
      by the GraphingStatisticsAppenders
    --&gt;
    &lt;appender name=&quot;graphsFileAppender&quot; class=&quot;org.apache.log4j.FileAppender&quot;&gt;
        &lt;param name=&quot;File&quot; value=&quot;perfGraphs.log&quot;/&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot; value=&quot;%m%n&quot;/&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

    &lt;!-- Loggers --&gt;
    &lt;!--
      The Perf4J logger. Note that org.perf4j.TimingLogger is the value of the
      org.perf4j.StopWatch.DEFAULT_LOGGER_NAME constant. Also, note that
      additivity is set to false, which is usually what is desired - this means
      that timing statements will only be sent to this logger and NOT to
      upstream loggers.
    --&gt;
    &lt;logger name=&quot;org.perf4j.TimingLogger&quot; additivity=&quot;false&quot;&gt;
        &lt;level value=&quot;INFO&quot;/&gt;
        &lt;appender-ref ref=&quot;CoalescingStatistics&quot;/&gt;
    &lt;/logger&gt;

    &lt;!--
      The root logger sends all log statements EXCEPT those sent to the perf4j
      logger to System.out.
    --&gt;
    &lt;root&gt;
        &lt;level value=&quot;INFO&quot;/&gt;
        &lt;appender-ref ref=&quot;console&quot;/&gt;
    &lt;/root&gt;
&lt;/log4j:configuration&gt;</pre></div>
<p>Here are some sample Google Chart API URLs that are written to the perfGraphs.log file together with the rendered graphs:</p>
<p><a class="externalLink" href="http://chart.apis.google.com/chart?cht=lxy&amp;chtt=Mean&amp;chs=750x400&amp;chxt=x,x,y&amp;chd=t:0.0,5.3,10.5,15.8,21.1,26.3,31.6,36.8,42.1,47.4,52.6,57.9,63.2,68.4,73.7,78.9,84.2,89.5,94.7,100.0|51.6,67.0,78.0,82.6,48.9,66.8,54.9,60.2,79.8,56.5,49.4,53.2,91.4,66.3,55.0,80.1,74.4,100.0,81.8,50.1|0.0,5.3,10.5,15.8,21.1,26.3,31.6,36.8,42.1,47.4,52.6,57.9,63.2,68.4,73.7,78.9,84.2,89.5,94.7,100.0|32.1,31.9,23.6,27.7,33.5,34.3,43.1,30.0,24.1,37.3,29.4,31.3,41.5,28.7,41.0,37.3,29.0,33.5,40.4,20.7&amp;chco=ff0000,00ff00&amp;chm=d,ff0000,0,-1,5.0|d,00ff00,1,-1,5.0&amp;chdl=secondBlock|firstBlock&amp;chxr=2,0,1545.8&amp;chxl=0:|14:29:00|14:29:30|14:30:00|14:30:30|14:31:00|14:31:30|14:32:00|1:|Time&amp;chxp=0,0.0,15.8,31.6,47.4,63.2,78.9,94.7|1,50&amp;chg=5.3,10">Mean Execution Times</a></p><img src="images/meanChart.png" alt="Mean Execution Times" />
<p><a class="externalLink" href="http://chart.apis.google.com/chart?cht=lxy&amp;chtt=TPS&amp;chs=750x400&amp;chxt=x,x,y&amp;chd=t:0.0,5.3,10.5,15.8,21.1,26.3,31.6,36.8,42.1,47.4,52.6,57.9,63.2,68.4,73.7,78.9,84.2,89.5,94.7,100.0|33.3,77.8,77.8,66.7,77.8,66.7,77.8,88.9,66.7,77.8,77.8,88.9,55.6,77.8,77.8,55.6,77.8,44.4,66.7,88.9|0.0,5.3,10.5,15.8,21.1,26.3,31.6,36.8,42.1,47.4,52.6,57.9,63.2,68.4,73.7,78.9,84.2,89.5,94.7,100.0|44.4,66.7,77.8,66.7,88.9,66.7,66.7,88.9,66.7,77.8,88.9,88.9,55.6,66.7,77.8,66.7,66.7,55.6,55.6,100.0&amp;chco=ff0000,00ff00&amp;chm=d,ff0000,0,-1,5.0|d,00ff00,1,-1,5.0&amp;chdl=secondBlock|firstBlock&amp;chxr=2,0,0.9&amp;chxl=0:|14:29:00|14:29:30|14:30:00|14:30:30|14:31:00|14:31:30|14:32:00|1:|Time&amp;chxp=0,0.0,15.8,31.6,47.4,63.2,78.9,94.7|1,50&amp;chg=5.3,10">Transactions Per Second</a></p><img src="images/tpsChart.png" alt="Transactions Per Second" /></div>
<div class="section">
<h4><a name="Exposing_Performance_Statistics_as_JMX_Attributes">Exposing Performance Statistics as JMX Attributes</a></h4>
<p>Another useful custom Perf4J appender is the <a href="./apidocs/org/perf4j/log4j/JmxAttributeStatisticsAppender.html">JmxAttributeStatisticsAppender</a>. This appender exposes performance statistics as attributes on a JMX MBean, and in addition it allows you to set thresholds for these statistics and send notifications when the logged values exceed the thresholds. There are many third party tools that are designed to interact with and monitor applications through JMX. Thus, exposing performance statistics through JMX opens a whole suite of additional functionality.</p>
<p>Again, extending the log4j.xml shown previously, the example file below adds a JmxAttributeStatisticsAppender to the CoalescingStatistics appender:</p>
<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE log4j:configuration SYSTEM &quot;log4j.dtd&quot;&gt;

&lt;log4j:configuration debug=&quot;false&quot; xmlns:log4j=&quot;http://jakarta.apache.org/log4j/&quot;&gt;
    &lt;!--
      This default ConsoleAppender is used to log all NON perf4j messages
      to System.out
    --&gt;
    &lt;appender name=&quot;console&quot; class=&quot;org.apache.log4j.ConsoleAppender&quot;&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot; value=&quot;%-5p %c{1} - %m%n&quot;/&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

    &lt;!-- Perf4J appenders --&gt;
    &lt;!--
      This AsyncCoalescingStatisticsAppender groups StopWatch log messages
      into GroupedTimingStatistics messages which it sends on the
      file appender defined below
    --&gt;
    &lt;appender name=&quot;CoalescingStatistics&quot;
              class=&quot;org.perf4j.log4j.AsyncCoalescingStatisticsAppender&quot;&gt;
        &lt;!--
          The TimeSlice option is used to determine the time window for which
          all received StopWatch logs are aggregated to create a single
          GroupedTimingStatistics log. Here we set it to 10 seconds, overriding
          the default of 30000 ms
        --&gt;
        &lt;param name=&quot;TimeSlice&quot; value=&quot;10000&quot;/&gt;
        &lt;appender-ref ref=&quot;fileAppender&quot;/&gt;
        &lt;appender-ref ref=&quot;graphExecutionTimes&quot;/&gt;
        &lt;appender-ref ref=&quot;graphExecutionTPS&quot;/&gt;
        &lt;!-- We add the JMX Appender reference onto the CoalescingStatistics --&gt;
        &lt;appender-ref ref=&quot;perf4jJmxAppender&quot;/&gt;
    &lt;/appender&gt;

    &lt;!-- This file appender is used to output aggregated performance statistics --&gt;
    &lt;appender name=&quot;fileAppender&quot; class=&quot;org.apache.log4j.FileAppender&quot;&gt;
        &lt;param name=&quot;File&quot; value=&quot;perfStats.log&quot;/&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot; value=&quot;%m%n&quot;/&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

    &lt;!--
      This first GraphingStatisticsAppender graphs Mean execution times for the
      firstBlock and secondBlock tags
    --&gt;
    &lt;appender name=&quot;graphExecutionTimes&quot;
              class=&quot;org.perf4j.log4j.GraphingStatisticsAppender&quot;&gt;
        &lt;!-- Possible GraphTypes are Mean, Min, Max, StdDev, Count and TPS --&gt;
        &lt;param name=&quot;GraphType&quot; value=&quot;Mean&quot;/&gt;
        &lt;!-- The tags of the timed execution blocks to graph are specified here --&gt;
        &lt;param name=&quot;TagNamesToGraph&quot; value=&quot;firstBlock,secondBlock&quot;/&gt;
        &lt;appender-ref ref=&quot;graphsFileAppender&quot;/&gt;
    &lt;/appender&gt;

    &lt;!--
      This second GraphingStatisticsAppender graphs transactions per second
      for the firstBlock and secondBlock tags
    --&gt;
    &lt;appender name=&quot;graphExecutionTPS&quot;
              class=&quot;org.perf4j.log4j.GraphingStatisticsAppender&quot;&gt;
        &lt;param name=&quot;GraphType&quot; value=&quot;TPS&quot;/&gt;
        &lt;param name=&quot;TagNamesToGraph&quot; value=&quot;firstBlock,secondBlock&quot;/&gt;
        &lt;appender-ref ref=&quot;graphsFileAppender&quot;/&gt;
    &lt;/appender&gt;

    &lt;!--
      This file appender is used to output the graph URLs generated
      by the GraphingStatisticsAppenders
    --&gt;
    &lt;appender name=&quot;graphsFileAppender&quot; class=&quot;org.apache.log4j.FileAppender&quot;&gt;
        &lt;param name=&quot;File&quot; value=&quot;perfGraphs.log&quot;/&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot; value=&quot;%m%n&quot;/&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

    &lt;!--
      This JMX appender creates an MBean and publishes it to the platform MBean server by
      default.
    --&gt;
    &lt;appender name=&quot;perf4jJmxAppender&quot; class=&quot;org.perf4j.log4j.JmxAttributeStatisticsAppender&quot;&gt;
        &lt;!--
          You must specify the tag names whose statistics should be exposed as
          MBean attributes.
        --&gt;
        &lt;param name=&quot;TagNamesToExpose&quot; value=&quot;firstBlock,secondBlock&quot;/&gt;
        &lt;!--
          The NotificationThresholds param configures the sending of JMX notifications
          when statistic values exceed specified thresholds. This config states that
          the firstBlock max value should be between 0 and 800ms, and the secondBlock max
          value should be less than 1500 ms. You can also set thresholds on the Min,
          Mean, StdDev, Count and TPS statistics - e.g. firstBlockMean(&lt;600).
        --&gt;
        &lt;param name=&quot;NotificationThresholds&quot; value=&quot;firstBlockMax(0-800),secondBlockMax(&amp;lt;1500)&quot;/&gt;
        &lt;!--
          You can also specify an optional MBeanName param, which overrides
          the default MBean name of org.perf4j:type=StatisticsExposingMBean,name=Perf4J
        --&gt;
    &lt;/appender&gt;

    &lt;!-- Loggers --&gt;
    &lt;!--
      The Perf4J logger. Note that org.perf4j.TimingLogger is the value of the
      org.perf4j.StopWatch.DEFAULT_LOGGER_NAME constant. Also, note that
      additivity is set to false, which is usually what is desired - this means
      that timing statements will only be sent to this logger and NOT to
      upstream loggers.
    --&gt;
    &lt;logger name=&quot;org.perf4j.TimingLogger&quot; additivity=&quot;false&quot;&gt;
        &lt;level value=&quot;INFO&quot;/&gt;
        &lt;appender-ref ref=&quot;CoalescingStatistics&quot;/&gt;
    &lt;/logger&gt;

    &lt;!--
      The root logger sends all log statements EXCEPT those sent to the perf4j
      logger to System.out.
    --&gt;
    &lt;root&gt;
        &lt;level value=&quot;INFO&quot;/&gt;
        &lt;appender-ref ref=&quot;console&quot;/&gt;
    &lt;/root&gt;
&lt;/log4j:configuration&gt;</pre></div>
<p>When running an application locally you can enable JMX by passing the system property com.sun.management.jmxremote on the command line, e.g.:</p>
<div class="source">
<pre>java -Dcom.sun.management.jmxremote -cp .:./perf4j-0.9.16.jar:./log4j-1.2.14.jar Perf4JAppenderExample</pre></div>
<p>Once the application is running, you can view the MBeans using the jconsole tool provided with the Sun JDK. Here is a screenshot showing the Perf4J MBean:</p><img src="images/jconsoleJmx.png" alt="JConsole showing Perf4J MBean" />
<p>Note that the exposed MBean supports two operations, exposeTag and removeTag, that allow you to change, at runtime, which tags' statistics are exposed as attributes. This is helpful if you are unsure, at deployment time, which tags are being logged in the application.</p>
<p>For more information on JMX see <a class="externalLink" href="http://java.sun.com/javase/technologies/core/mntr-mgmt/javamanagement">Sun's JMX website</a>.</p></div></div>
<div class="section">
<h3><a name="Exposing_Performance_Graphs_in_a_Web_Application">Exposing Performance Graphs in a Web Application</a></h3>
<p>One of the most common application types that require good performance monitoring are web applications. If you have previously configured a GraphingStatisticsAppender <a href="#Writing_Graphs_with_the_GraphingStatisticsAppender">as described above</a>, you can load a <a href="./apidocs/org/perf4j/log4j/servlet/GraphingServlet.html">GraphingServlet</a> in your web.xml file to expose performance graphs through a browser front end. Here is an example web.xml file:</p>
<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;web-app version=&quot;2.4&quot;
         xmlns=&quot;http://java.sun.com/xml/ns/j2ee&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/j2ee
                             http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;perf4j&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.perf4j.log4j.servlet.GraphingServlet&lt;/servlet-class&gt;
        &lt;!--
          The graphNames parameter determines which graphs to expose. The
          param-value should be a comma-separated list of the
          appender NAMES as defined in the log4j.xml file.
        --&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;graphNames&lt;/param-name&gt;
            &lt;param-value&gt;graphExecutionTimes,graphExecutionTPS&lt;/param-value&gt;
        &lt;/init-param&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;perf4j&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/perf4j&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</pre></div>
<p>The GraphingServlet accesses the in-memory graph representations from the GraphingStatisticsAppenders when displaying the graphs, and thus it always displays the most up-to-date data. Also, you may find with the GraphingServlet that you no longer have a need for the GraphingStatisticsAppenders to write to a file. In that case you can remove any file appenders attached to the GraphingStatisticsAppenders in the log4j.xml file.</p>
<p>Note that as with the logback appenders, there is also a logback version of the <a href="./apidocs/org/perf4j/logback/servlet/GraphingServlet.html">GraphingServlet</a>.</p></div>
<div class="section">
<h3><a name="Unobtrusive_Logging_with_Profiled_and_AOP">Unobtrusive Logging with @Profiled and AOP</a></h3>
<p>One of the downsides to adding StopWatch timing statements to code is that they can clutter the business logic of a method, reducing the &quot;signal-to-noise ratio&quot; of the code. The <a href="./apidocs/org/perf4j/aop/Profiled.html">Profiled</a> annotation provided by Perf4J provides a very clean way to time method calls while keeping the executable statements free from distracting StopWatch calls. Note that the Profiled annotation by itself just marks a method for profiling - it does not actually add any timing code. Instead, you must use an aspect-oriented programming framework, such as <a class="externalLink" href="http://www.eclipse.org/aspectj/">AspectJ</a> or <a class="externalLink" href="http://static.springframework.org/spring/docs/2.5.x/reference/aop.html">Spring AOP</a> to inject timing aspects into your code.</p>
<p>In addition, Perf4J has also added support for EJB Interceptors. In the case of EJB interceptors, the Profiled annotation is optional, and only needs to be specified if you wish to override the default tag name and message.</p>
<div class="section">
<h4><a name="Adding_the_Profiled_Annotation_to_Method_Declarations">Adding the Profiled Annotation to Method Declarations</a></h4>
<p>Adding the Profiled annotation to Java methods is a very simple and straightforward process. The following class displays a number of sample methods and usages of the Profiled annotation:</p>
<div class="source">
<pre>import org.perf4j.aop.*;

public class ProfiledExample {
    public static void main (String[] args) throws Exception {
        // run all of the examples
        for (int i = 0; i &lt; 50; i++) {
            simpleExample();
            simpleExampleWithExplicitTag();
            dynamicTagExample(&quot;iIs&quot; + (i % 2 == 0 ? &quot;Even&quot; : &quot;Odd&quot;));
            dynamicMessageExample(i % 2 == 0 ? 1000L : 2000L);
            if (i % 2 == 0) {
                logFailuresSeparatelyExample(false);
            } else {
                try {
                    logFailuresSeparatelyExample(true);
                } catch (Exception e) { /* expected */ }
            }
            nonDefaultLoggerNameExample();

            System.out.println(&quot;Ran loop &quot; + i);
        }
    }

    /**
     * When the Profiled annotation is used without any parameters, the simple
     * name of the method is used as the tag for any logged timing statements
     */
    @Profiled
    public static void simpleExample() throws InterruptedException {
        Thread.sleep((long) (Math.random() * 1000L));
    }

    /**
     * Here we set the tag name to an explicit value.
     */
    @Profiled(tag = &quot;simpleBlock&quot;)
    public static void simpleExampleWithExplicitTag() throws InterruptedException {
        Thread.sleep((long) (Math.random() * 1000L));
    }

    /**
     * One very useful feature of the Profiled annotation is the ability to
     * dynamically set the tag name based on the value of a method parameter.
     * You can make use of Jakarta Commons Java Expression Language (JEXL) in
     * curly braces in the tag name. The first parameter is assigned the variable
     * name $0, the second $1, etc. For example, if I had a method that took as
     * the first parameter an object with a bean accessor method &quot;getFoo()&quot;, I
     * could write a tag as &quot;myTag_{$0.foo}&quot;.
     *
     * In addition to method parameters, you can also access the following variables
     * in JEXL expressions:
     *
     * $this - the object whose method is being called.
     * $return - the return value from the method (this will be null if the method
     *           has a void return type or if the method throws an exception).
     * class java.lang.Object - the Class instance of the class owning the method being called.
     * $methodName - the name of the method being called.
     * $exception - if the method completes by throwing an exception, the $exception
     *              variable can be used to access the exception (this will be null
     *              if the method completes normlly).
     *
     */
    @Profiled(tag = &quot;dynamicTag_{$0}&quot;)
    public static void dynamicTagExample(String tagName) throws InterruptedException {
        Thread.sleep((long) (Math.random() * 1000L));
    }

    /**
     * You can also specify a message to be logged in the Profiled annotation.
     */
    @Profiled(tag = &quot;messageExample&quot;, message = &quot;Requested sleep time was {$0 / 1000} seconds&quot;)
    public static void dynamicMessageExample(long requestedSleepTimeInMS) throws InterruptedException {
        Thread.sleep((long) (Math.random() * requestedSleepTimeInMS));
    }

    /**
     * Often times you want to log failures (where a method completes by throwing an exception)
     * separately from when a method completes normally. If you set the logFailuresSeparately
     * parameter to true, then the tag given to cases when the method completes normally will
     * be yourSpecifiedTagName.success, and when an exception is thrown the tag name will be
     * yourSpecifiedTagName.failure. This allows you to calculate separate performance statistics
     * for success and failure cases.
     */
    @Profiled(tag = &quot;failuresSeparatelyExample&quot;, logFailuresSeparately = true)
    public static void logFailuresSeparatelyExample(boolean shouldFail) throws Exception {
        Thread.sleep((long) (Math.random() * 1000L));
        if (shouldFail) {
            throw new Exception(&quot;Method threw exception&quot;);
        }
    }

    /**
     * By default timing statements are logged to the logger named
     * StopWatch.DEFAULT_LOGGER_NAME (i.e. org.perf4j.TimingLogger),
     * but this can be overridden.
     */
    @Profiled(tag = &quot;loggerExample&quot;, logger = &quot;org.perf4j.MyCustomLoggerName&quot;)
    public static void nonDefaultLoggerNameExample() throws InterruptedException {
        Thread.sleep((long) (Math.random() * 1000L));
    }
}</pre></div>
<p>If you compile and run this class you will notice that no timing statements are printed to any logs. This is because you need to integrate one of the timing aspects that ship with Perf4J using one of the methods described below.</p></div>
<div class="section">
<h4><a name="Using_AspectJ_Load-Time_Weaving_to_Integrate_Timing_Aspects_at_Run_Time">Using AspectJ Load-Time Weaving to Integrate Timing Aspects at Run Time</a></h4>
<p>AspectJ is an aspect-oriented programming extension for Java hosted by the Eclipse Foundation. Perf4J ships with aspects that will &quot;surround&quot; methods that have the Profiled annotation with LoggingStopWatch timing statements (if desired you can examine the code for the <a href="./xref/org/perf4j/aop/AbstractTimingAspect.html">AbstractTimingAspect</a> and <a href="#xreforgperf4jlog4jaopTimingAspect.html">log4j TimingAspect</a> classes to see what they do). AspectJ provides several ways to &quot;weave&quot; these aspects into code, one of which is to use the AspectJ load-time weaver, which injects the aspect code into the woven classes as they are loaded.</p>
<p><b>IMPORTANT</b> To use AspectJ's load-time weaver and the aspect code you will need the following jars:</p>
<ul>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/org/aspectj/aspectjweaver/1.6.1/aspectjweaver-1.6.1.jar">aspectjweaver-1.6.1.jar</a>, the AspectJ load-time weaver java agent</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/org/aspectj/aspectjrt/1.6.1/aspectjrt-1.6.1.jar">aspectjrt-1.6.1.jar</a>, the AspectJ runtime</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/log4j/log4j/1.2.14/log4j-1.2.14.jar">log4j-1.2.14.jar</a>, the log4j classes (note if you are using the SLF4J/logback aspects you should use the <a class="externalLink" href="http://repo1.maven.org/maven2/ch/qos/logback/logback-classic/logback-classic-0.9.15.jar">logback-classic-0.9.15.jar</a> and <a class="externalLink" href="http://repo1.maven.org/maven2/org/slf4j/slf4j-api/slf4j-api-1.5.6.jar">slf4j-api-1.5.6.jar</a> jar files)</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/commons-jexl/commons-jexl/1.1/commons-jexl-1.1.jar">commons-jexl-1.1.jar</a>, the Jakarta Commons Java Expression Language (JEXL) runtime, which is used by the aspects when examining the Profiled annotations</li>
<li><a class="externalLink" href="http://repo2.maven.org/maven2/commons-logging/commons-logging/1.0.3/commons-logging-1.0.3.jar">commons-logging-1.0.3.jar</a>, which is a dependency of JEXL
<p>To run the AspectJ weaver, you will first need to create an &quot;aop.xml&quot; file which must exist at META-INF/aop.xml in the classpath. Here is an example:</p>
<div class="source">
<pre>&lt;!DOCTYPE aspectj PUBLIC &quot;-//AspectJ//DTD//EN&quot; &quot;http://www.eclipse.org/aspectj/dtd/aspectj.dtd&quot;&gt;

&lt;aspectj&gt;
  &lt;!--
    We only want to weave in the log4j TimingAspect into the @Profiled classes.
    Note that Perf4J provides TimingAspects for the most popular Java logging
    frameworks and facades: log4j, java.util.logging, Apache Commons Logging
    and SLF4J. The TimingAspect you specify here will depend on which logging
    framework you wish to use in your code.
  --&gt;
  &lt;aspects&gt;
    &lt;aspect name=&quot;org.perf4j.log4j.aop.TimingAspect&quot;/&gt;
    &lt;!-- if SLF4J/logback use org.perf4j.slf4j.aop.TimingAspect instead --&gt;
  &lt;/aspects&gt;

  &lt;weaver options=&quot;-verbose -showWeaveInfo&quot;&gt;
    &lt;!--
      Here is where we specify the classes to be woven. You can specify package
      names like com.company.project.*
    --&gt;
    &lt;include within=&quot;ProfiledExample&quot;/&gt;
  &lt;/weaver&gt;
&lt;/aspectj&gt;</pre></div>
<p>The complete set of steps to run the ProfiledExample class defined above with profiling enabled is:</p>
<ol style="list-style-type: decimal">
<li>Compile the ProfiledExample class using javac:
<p><tt>javac -cp perf4j-0.9.16.jar ProfiledExample.java</tt></p></li>
<li>Ensure that the log4j.xml file (you can use any of the ones defined in this guide) is in the current directory.</li>
<li>Ensure that the aop.xml file defined above exists at ./META-INF/aop.xml.</li>
<li>Run the class using java, specifying the AspectJ weaver as a java agent (note the path separator should be ; when running in Windows, and the classpath assumes all the dependency jars are in the current directory):
<p><tt>java -cp .:perf4j-0.9.16.jar:log4j-1.2.14.jar:aspectjrt-1.6.1.jar:commons-jexl-1.1.jar:commons-logging-1.0.3.jar -javaagent:aspectjweaver-1.6.1.jar ProfiledExample</tt></p></li></ol>
<p>When the ProfiledExample class is executed with the integrated timing statements log files are generated just as if the StopWatch timing statements were written directly in the code:</p>
<div class="source">
<pre>Performance Statistics   19:53:20 - 19:53:30
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
dynamicTag_iIsEven                                      44.0          44          44         0.0           1
dynamicTag_iIsOdd                                      561.0         561         561         0.0           1
failuresSeparatelyExample.failure                      775.0         736         814        39.0           2
failuresSeparatelyExample.success                       81.0          81          81         0.0           1
messageExample                                         868.7         742         965        93.5           3
simpleBlock                                            576.5         265         888       311.5           2
simpleExample                                          727.0         599         855       128.0           2</pre></div></li></ul></div>
<div class="section">
<h4><a name="Using_the_AspectJ_Compiler_to_Integrate_Timing_Aspects_at_Compile_Time">Using the AspectJ Compiler to Integrate Timing Aspects at Compile Time</a></h4>
<p>The AspectJ compiler, ajc, allows you to weave the timing aspects into your code at compile time. You will need to <a class="externalLink" href="http://www.eclipse.org/aspectj/downloads.php">download the AspectJ toolset</a> and install it first. Using the ProfiledExample class from above, you can integrate the aspects using the following steps.</p>
<p><b>IMPORTANT</b> In addition to the main perf4j-0.9.16.jar file, Perf4J also provides jars that are specific to each of the different logging frameworks that contain only the TimingAspect specific to that framework. You can download the jar with the logging framework you wish to use from the <a href="./downloads.html">downloads</a> page. When calling ajc it is <b>critical</b> that you do <b>NOT</b> use the main perf4j-0.9.16.jar in your inpath. If you do this, ajc will weave ALL defined aspects into your classes, and you always only want one TimingAspect to run for each method you have marked with the Profiled annotation. The example steps below assume you are using log4j.</p>
<ol style="list-style-type: decimal">
<li>First, ensure that you have all the required files and dependencies in your current directory:
<ul>
<li><a class="externalLink" href="http://repository.codehaus.org/org/perf4j/perf4j/0.9.16/perf4j-0.9.16-log4jonly.jar">perf4j-0.9.16-log4jonly.jar</a>, the jar which contains only the log4j aspects and not the java.util.logging aspects</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/log4j/log4j/1.2.14/log4j-1.2.14.jar">log4j-1.2.14.jar</a>, the log4j classes (again, if you are using the SLF4J/logback aspects you should use the <a class="externalLink" href="http://repo1.maven.org/maven2/ch/qos/logback/logback-classic/logback-classic-0.9.15.jar">logback-classic-0.9.15.jar</a> and <a class="externalLink" href="http://repo1.maven.org/maven2/org/slf4j/slf4j-api/slf4j-api-1.5.6.jar">slf4j-api-1.5.6.jar</a> jar files)</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/commons-jexl/commons-jexl/1.1/commons-jexl-1.1.jar">commons-jexl-1.1.jar</a>, the Jakarta Commons Java Expression Language (JEXL) runtime, which is used by the aspects when examining the Profiled annotations</li>
<li><a class="externalLink" href="http://repo2.maven.org/maven2/commons-logging/commons-logging/1.0.3/commons-logging-1.0.3.jar">commons-logging-1.0.3.jar</a>, which is a dependency of JEXL</li>
<li>The ProfiledExample.java file given above</li>
<li>Any of the log4j.xml configuration files from this guide</li></ul></li>
<li>Run the ajc compiler to weave the timing aspects into the ProfiledExample class (assumes the $ASPECTJ_DIR environment variable points to your AspectJ tools installation directory):
<p><tt>$ASPECTJ_DIR/bin/ajc -classpath $ASPECTJ_DIR/lib/aspectjrt.jar -1.5 -inpath perf4j-0.9.16-log4jonly.jar -outjar profiledExampleWoven.jar ProfiledExample.java</tt></p>
<p>This will create a new jar named profiledExampleWoven.jar that includes the ProfiledExample class with the log4j TimingAspects integrated to execute around the methods with the Profiled annotation.</p></li>
<li>Execute the example using java, being sure to include the required dependencies in the classpath. Note that the perf4j-0.9.16-log4jonly.jar is NOT in the classpath, as those classes have been incorporated into profiledExampleWoven.jar:
<p><tt>java -cp .:profiledExampleWoven.jar:$ASPECTJ_DIR/lib/aspectjrt.jar:log4j-1.2.14.jar:commons-jexl-1.1.jar:commons-logging-1.0.3.jar ProfiledExample</tt></p>
<p>Note that if you execute the program with perf4j-0.9.16-log4jonly.jar in the classpath you are likely to see &quot;java.lang.NoSuchMethodError: aspectOf&quot; errors thrown in your code. This is because perf4j-0.9.16-log4jonly.jar has only been compiled with javac, not the ajc compiler (compiling with the ajc compiler first would cause problems with load-time weaving). Thus, if you do see this error be sure that the default perf4j jars are not in your class path and that you are using the -inpath and -outjar options of ajc correctly.</p></li></ol>
<p>There are a number of different ways to compile with ajc. For more information, see the <a class="externalLink" href="http://www.eclipse.org/aspectj/doc/released/devguide/ajc-ref.html">ajc documentation</a>.</p></div>
<div class="section">
<h4><a name="Using_Spring_AOP_to_Integrate_Timing_Aspects">Using Spring AOP to Integrate Timing Aspects</a></h4>
<p>The Spring Application Framework provides a large toolset for working with aspects and integrating them with Spring-managed beans. If you already use Spring in your application, Spring AOP may be the simplest method for integrating the timing aspects into your code, provided you can live with the restrictions outlined below. Note that the small example given here makes use of just a small part of Spring AOP; you will likely want to review the <a class="externalLink" href="http://static.springframework.org/spring/docs/2.5.x/reference/aop.html">Spring AOP documentation</a> for more information.</p>
<p>Spring AOP uses a proxy-based framework to weave aspects into Spring-managed beans, either using JDK dynamic proxies (when the bean being proxied implements at least one interface) or CGLIB proxies. As such, there are a couple of important restrictions when using Spring AOP:</p>
<ul>
<li>Any objects to be woven must exist as Spring-managed beans declared in the Spring container. This is necessary because, in order to wrap object instances with the required proxies, the Spring container needs to control the lifecycle of your objects.</li>
<li>Any method being @Profiled MUST be a public method.</li>
<li>If you have a method on your spring bean that calls another @Profiled method directly, then that method will NOT be timed as you will not be going through the Spring proxy to make the call. Note this is NOT the case when using AspectJ directly. The Spring documentation <a class="externalLink" href="http://static.springframework.org/spring/docs/2.5.x/reference/aop.html#aop-understanding-aop-proxies">explains the effect proxies have</a> on AOP-enabled methods.</li></ul>
<p>If your code does not fit these restrictions, Spring still has some utilities for using native AspectJ load-time weaving with Spring - see <a class="externalLink" href="http://static.springframework.org/spring/docs/2.5.x/reference/aop.html#aop-aj-ltw">Spring's load-time weaving documentation</a> for more.</p>
<p>For this example, assume we have the following class that we will load as a Spring-managed bean:</p>
<div class="source">
<pre>import java.math.BigInteger;
import org.perf4j.aop.Profiled;

public class PrimeGenerator {

    //keeps track of the prime we're going to return
    private BigInteger currentPrime = new BigInteger(&quot;0&quot;);

    public void setCurrentPrime(BigInteger currentPrime) {
        this.currentPrime = currentPrime;
    }

    @Profiled
    public BigInteger nextPrime() {
        currentPrime = currentPrime.nextProbablePrime();
        return currentPrime;
    }
}</pre></div>
<p>This simple bean just reports a running series of prime numbers. The Profiled annotation has been added to allow us to track the execution time of the nextPrime() method.</p>
<p>The following sample spring.xml file sets up the bean and uses Spring's autoproxy feature to weave in the log4j TimingAspect:</p>
<div class="source">
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;!-- Note how the aop namespace is defined in the top-level beans element --&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
                           http://www.springframework.org/schema/aop
                           http://www.springframework.org/schema/aop/spring-aop-2.0.xsd&quot;&gt;

    &lt;!--
      Including this aspectj-autoproxy element will cause spring to automatically
      create proxies around any beans defined in this file that match the pointcuts
      of any aspects defined in this file.
    --&gt;
    &lt;aop:aspectj-autoproxy/&gt;

    &lt;!--
      Declare the TimingAspect that we want to weave into the other beans
      defined in this config file.
    --&gt;
    &lt;bean id=&quot;timingAspect&quot; class=&quot;org.perf4j.log4j.aop.TimingAspect&quot;/&gt;

    &lt;!--
      Because we included the aspectj-autoproxy element, Spring will automatically
      create a proxy for this bean that runs the TimingAspect around any public
      @Profiled methods on this bean.
    --&gt;
    &lt;bean id=&quot;primeGenerator&quot; class=&quot;PrimeGenerator&quot;&gt;
        &lt;property name=&quot;currentPrime&quot;
                  value=&quot;12345678910111213141516171819202122232425262728293031323334353637383940&quot;/&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</pre></div>
<p>Finally, we provide a main class to start up Spring and call the nextPrime() method:</p>
<div class="source">
<pre>import org.springframework.context.ApplicationContext;
import org.springframework.context.support.FileSystemXmlApplicationContext;

public class SpringProfiledExample {
    public static void main(String[] args) throws Exception {
        //initialize Spring
        ApplicationContext applicationContext = new FileSystemXmlApplicationContext(&quot;spring.xml&quot;);

        //Spring will actually return a CGLIB-generated proxy here that injects
        //the TimingAspects into the PrimeGenerator class.
        PrimeGenerator primeGenerator = (PrimeGenerator) applicationContext.getBean(&quot;primeGenerator&quot;);

        for (int i = 0; i &lt; 500; i++) {
            System.out.println(&quot;nextPrime() returned &quot; + primeGenerator.nextPrime());
        }
    }
}</pre></div>
<p>To run the example:</p>
<ol style="list-style-type: decimal">
<li>First, ensure that you have all the required files and dependencies in your current directory (note it is usually easiest to use Maven or Ant to manage dependencies, see the <a href="./downloads.html">downloads page</a>):
<ul>
<li><a class="externalLink" href="http://repository.codehaus.org/org/perf4j/perf4j/0.9.16/perf4j-0.9.16.jar">perf4j-0.9.16.jar</a></li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/org/springframework/spring/2.0.6/spring-2.0.6.jar">spring-2.0.6.jar</a>, the Spring Framework jar</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/org/aspectj/aspectjweaver/1.6.1/aspectjweaver-1.6.1.jar">aspectjweaver-1.6.1.jar</a>, the AspectJ load-time weaver java agent</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/org/aspectj/aspectjrt/1.6.1/aspectjrt-1.6.1.jar">aspectjrt-1.6.1.jar</a>, the AspectJ runtime</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/cglib/cglib/2.1_3/cglib-2.1_3.jar">cglib-2.1_3.jar</a>, the CGLIB library needed by Spring to create the proxies</li>
<li><a class="externalLink" href="http://repo2.maven.org/maven2/asm/asm/1.5.3/asm-1.5.3.jar">asm-1.5.3.jar</a>, a dependency of CGLIB</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/log4j/log4j/1.2.14/log4j-1.2.14.jar">log4j-1.2.14.jar</a>, the log4j classes</li>
<li><a class="externalLink" href="http://repo1.maven.org/maven2/commons-jexl/commons-jexl/1.1/commons-jexl-1.1.jar">commons-jexl-1.1.jar</a>, the Jakarta Commons Java Expression Language (JEXL) runtime, which is used by the aspects when examining the Profiled annotations</li>
<li><a class="externalLink" href="http://repo2.maven.org/maven2/commons-logging/commons-logging/1.0.3/commons-logging-1.0.3.jar">commons-logging-1.0.3.jar</a>, which is a dependency of JEXL</li>
<li>The PrimeGenerator.java, spring.xml and SpringProfiledExample.java files given above</li>
<li>Any of the log4j.xml configuration files from this guide</li></ul></li>
<li>Compile the PrimeGenerator and SpringProfiledExample classes:
<p><tt>javac -cp perf4j-0.9.16.jar:spring-2.0.6.jar PrimeGenerator.java SpringProfiledExample.java</tt></p></li>
<li>Run SpringProfiledExample:
<p><tt>java -cp .:perf4j-0.9.16.jar:spring-2.0.6.jar:aspectjrt-1.6.1.jar:aspectjweaver-1.6.1.jar:cglib-2.1_3.jar:asm-1.5.3.jar:log4j-1.2.14.jar:commons-jexl-1.1.jar:commons-logging-1.0.3.jar SpringProfiledExample</tt></p></li></ol>
<p>Some sample output printed to the perfStats.log file:</p>
<div class="source">
<pre>Performance Statistics   18:46:50 - 18:47:00
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
nextPrime                                               31.3          24          73         6.9         277

Performance Statistics   18:47:00 - 18:47:10
Tag                                                  Avg(ms)         Min         Max     Std Dev       Count
nextPrime                                               31.0          24          78         7.2         223</pre></div></div>
<div class="section">
<h4><a name="Using_EJB_Interceptors_to_Integrate_Timing_Aspects">Using EJB Interceptors to Integrate Timing Aspects</a></h4>
<p>EJB 3.0 added support for interceptors, and Perf4J provides interceptors that add the timing calls when a target method is invoked. Here is an example of a session bean with a method that will be profiled:</p>
<div class="source">
<pre>@Stateless
public class HelloWorldBean implements HelloWorld {

    @Interceptors(org.perf4j.log4j.aop.EjbTimingAspect.class)
    public void sayHello() {
        System.out.println(&quot;Hello!&quot;);
    }
}</pre></div>
<p>When the sayHello method is executed, it will be wrapped by Log4JStopWatch start/stop calls. Note that the sayHello method has no Profiled annotation, and so by default the tag name used will be the method name (i.e. sayHello) and there will me no message on the stop watch. You can optionally add a Profiled annotation to the method if you wish to set a different tag name, or to otherwise take advantage of the configuration options that the Profiled annotation provides.</p></div></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2008-2016
                        <a href="http://www.perf4j.org">perf4j.org</a>.
            All Rights Reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
